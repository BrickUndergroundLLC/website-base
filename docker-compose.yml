# Mortar CMS - Website Base Docker Compose
# 
# This is the base configuration for any website running on the Mortar CMS platform.
# It connects to the shared network from the root docker-compose.yml to access
# shared services like postgres, redis, and nginx.
#
# Local development URL: https://lcl.example.com
# API endpoint: https://lcl.example.com/api
# Django Admin: https://lcl.example.com/admin
#
# Usage:
#   docker compose up -d
#
# Note: Make sure the root docker-compose.yml is running first to have the
# shared network (bndventures-network) available.

services:
  # Next.js Frontend
  example-web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: example-web
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=https://lcl.example.com/api
      - NEXT_PUBLIC_SITE_URL=https://lcl.example.com
      - NEXT_TELEMETRY_DISABLED=1
    ports:
      - "3010:3000"
    networks:
      - bndventures-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Django API
  example-api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: example-api
    restart: unless-stopped
    command: >
      sh -c "python manage.py migrate &&
             python manage.py collectstatic --noinput &&
             gunicorn --bind 0.0.0.0:8000 --workers 3 mortarcms_base.wsgi:application"
    environment:
      - DEBUG=True
      - IS_LOCAL_DEV=True
      - SECRET_KEY=local-development-secret-key-not-for-production
      - DB_NAME=example_db
      - DB_USER=mortarcms
      - DB_PASSWORD=mortarcms_password
      - DB_HOST=postgres
      - DB_PORT=5432
      - ALLOWED_HOSTS=lcl.example.com,example-api,localhost
      - CORS_ALLOWED_ORIGINS=https://lcl.example.com,http://localhost:3010
      - CELERY_BROKER_URL=redis://redis:6379/1
      - REDIS_URL=redis://redis:6379/1
      - SITE_URL=https://lcl.example.com
      - EMAIL_FROM=hello@example.com
    ports:
      - "8010:8000"
    volumes:
      - example-media:/app/media
      - example-static:/app/staticfiles
    networks:
      - bndventures-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Celery Worker for background tasks
  example-celery-worker:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: example-celery-worker
    restart: unless-stopped
    command: celery -A mortarcms_base worker -l info
    environment:
      - DEBUG=True
      - IS_LOCAL_DEV=True
      - SECRET_KEY=local-development-secret-key-not-for-production
      - DB_NAME=example_db
      - DB_USER=mortarcms
      - DB_PASSWORD=mortarcms_password
      - DB_HOST=postgres
      - DB_PORT=5432
      - CELERY_BROKER_URL=redis://redis:6379/1
      - REDIS_URL=redis://redis:6379/1
      - EMAIL_FROM=hello@example.com
    volumes:
      - example-media:/app/media
      - example-static:/app/staticfiles
    depends_on:
      - example-api
    networks:
      - bndventures-network

  # Celery Beat for scheduled tasks
  example-celery-beat:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: example-celery-beat
    restart: unless-stopped
    command: celery -A mortarcms_base beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    environment:
      - DEBUG=True
      - IS_LOCAL_DEV=True
      - SECRET_KEY=local-development-secret-key-not-for-production
      - DB_NAME=example_db
      - DB_USER=mortarcms
      - DB_PASSWORD=mortarcms_password
      - DB_HOST=postgres
      - DB_PORT=5432
      - CELERY_BROKER_URL=redis://redis:6379/1
      - REDIS_URL=redis://redis:6379/1
      - EMAIL_FROM=hello@example.com
    volumes:
      - example-media:/app/media
      - example-static:/app/staticfiles
    depends_on:
      - example-api
    networks:
      - bndventures-network

# Connect to the shared network from root docker-compose.yml
# This network must already exist (created by the root docker-compose.yml)
networks:
  bndventures-network:
    external: true
    name: mortarcms

# Local volumes for this website's data
volumes:
  example-media:
  example-static:
